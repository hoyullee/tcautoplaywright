name: Run Playwright Tests

on:
  repository_dispatch:
    types: [run_playwright_tests]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
      
      - name: Python 3.11 ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          pip install playwright requests python-dotenv
          playwright install chromium
      
      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          export LAAS_API_KEY="${{ secrets.LAAS_API_KEY }}"
          export PROJECT_CODE="${{ secrets.PROJECT_CODE }}"
          export PRESET_HASH="${{ secrets.PRESET_HASH }}"
          export TEST_CASES='${{ toJson(github.event.client_payload.test_cases) }}'
          
          echo "======================================"
          echo "ğŸ” í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì „ í™˜ê²½ë³€ìˆ˜ í™•ì¸"
          echo "======================================"
          echo "LAAS_API_KEY ì¡´ì¬: $([[ -n "$LAAS_API_KEY" ]] && echo 'Yes' || echo 'No')"
          echo "LAAS_API_KEY ê¸¸ì´: ${#LAAS_API_KEY}"
          echo "PROJECT_CODE: $PROJECT_CODE"
          echo "PRESET_HASH ì¡´ì¬: $([[ -n "$PRESET_HASH" ]] && echo 'Yes' || echo 'No')"
          echo "PRESET_HASH ê¸¸ì´: ${#PRESET_HASH}"
          echo "======================================"
          echo ""
          
          python main_github.py
      
      - name: ê²°ê³¼ ì»¤ë°‹ ë° í‘¸ì‹œ
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git add test/
          git commit -m "Test results from $(date +'%Y-%m-%d %H:%M:%S')" || echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          git push origin master