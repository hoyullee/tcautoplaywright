name: Run Playwright Tests

on:
  repository_dispatch:
    types: [run_playwright_tests]
  workflow_dispatch:  # 수동 실행 추가

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: 체크아웃
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Python 3.11 설정
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: 의존성 설치
        run: |
          pip install playwright requests python-dotenv
          playwright install chromium
      
      - name: 테스트 실행
        env:
          LAAS_API_KEY: ${{ secrets.LAAS_API_KEY }}
          PROJECT_CODE: ${{ secrets.PROJECT_CODE }}
          PRESET_HASH: ${{ secrets.PRESET_HASH }}
          TEST_CASES: ${{ toJson(github.event.client_payload.test_cases) }}
        run: |
          python main_github.py
      
      - name: 결과 커밋 및 푸시
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git add generated_codes/ test_results/ screenshots/ logs/
          git commit -m "Test results from $(date +'%Y-%m-%d %H:%M:%S')" || echo "변경사항 없음"
          git push
