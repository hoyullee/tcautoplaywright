name: Run Playwright Tests

on:
  repository_dispatch:
    types: [run_playwright_tests]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
      
      - name: Python 3.11 ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          pip install playwright requests python-dotenv
          playwright install chromium
      
      - name: í™˜ê²½ë³€ìˆ˜ í™•ì¸ (ë””ë²„ê¹…)
        env:
          LAAS_API_KEY: ${{ secrets.LAAS_API_KEY }}
          PROJECT_CODE: ${{ secrets.PROJECT_CODE }}
          PRESET_HASH: ${{ secrets.PRESET_HASH }}
        run: |
          echo "======================================"
          echo "ğŸ” GitHub Secrets ì „ë‹¬ í™•ì¸"
          echo "======================================"
          if [ -n "$LAAS_API_KEY" ]; then
            echo "âœ… LAAS_API_KEY: ì„¤ì •ë¨ (ê¸¸ì´: ${#LAAS_API_KEY}ì)"
            echo "   ì‹œì‘ 10ì: ${LAAS_API_KEY:0:10}..."
          else
            echo "âŒ LAAS_API_KEY: ì—†ìŒ"
          fi
          
          if [ -n "$PROJECT_CODE" ]; then
            echo "âœ… PROJECT_CODE: $PROJECT_CODE"
          else
            echo "âŒ PROJECT_CODE: ì—†ìŒ"
          fi
          
          if [ -n "$PRESET_HASH" ]; then
            echo "âœ… PRESET_HASH: ì„¤ì •ë¨ (ê¸¸ì´: ${#PRESET_HASH}ì)"
            echo "   ì‹œì‘ 15ì: ${PRESET_HASH:0:15}..."
          else
            echo "âŒ PRESET_HASH: ì—†ìŒ"
          fi
          echo "======================================"
          echo ""
          echo "ğŸ Pythonì—ì„œë„ í™•ì¸:"
          python3 -c "import os; print(f'LAAS_API_KEY: {\"ìˆìŒ\" if os.environ.get(\"LAAS_API_KEY\") else \"ì—†ìŒ\"}')"
          python3 -c "import os; print(f'PROJECT_CODE: {os.environ.get(\"PROJECT_CODE\", \"ì—†ìŒ\")}')"
          python3 -c "import os; print(f'PRESET_HASH: {\"ìˆìŒ\" if os.environ.get(\"PRESET_HASH\") else \"ì—†ìŒ\"}')"
      
      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        env:
          LAAS_API_KEY: ${{ secrets.LAAS_API_KEY }}
          PROJECT_CODE: ${{ secrets.PROJECT_CODE }}
          PRESET_HASH: ${{ secrets.PRESET_HASH }}
          TEST_CASES: ${{ toJson(github.event.client_payload.test_cases) }}
        run: |
          python main_github.py
      
      - name: ê²°ê³¼ ì»¤ë°‹ ë° í‘¸ì‹œ
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git add generated_codes/ test_results/ screenshots/ logs/
          git commit -m "Test results from $(date +'%Y-%m-%d %H:%M:%S')" || echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          git push origin master