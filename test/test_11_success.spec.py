from playwright.async_api import async_playwright
import asyncio
import sys
import os

# â­ í…ŒìŠ¤íŠ¸ ê³„ì • ì •ë³´ (ë¡œê·¸ì¸ í•„ìš” ì‹œ)
TEST_EMAIL = "hoyul.lee+1@wantedlab.com"
TEST_PASSWORD = "wanted12!@"

async def main():
    async with async_playwright() as p:
        # ë¸Œë¼ìš°ì € ì‹¤í–‰
        browser = await p.firefox.launch(headless=True)

        # í•œêµ­ì–´ ì„¤ì •
        context = await browser.new_context(
            locale='ko-KR',
            timezone_id='Asia/Seoul'
        )
        page = await context.new_page()

        try:
            # screenshots í´ë” ìƒì„±
            os.makedirs('screenshots', exist_ok=True)

            # í˜ì´ì§€ ì ‘ì†
            print("ğŸŒ í˜ì´ì§€ ì ‘ì†: https://www.wanted.co.kr/")
            await page.goto('https://www.wanted.co.kr/', timeout=30000)
            await page.wait_for_load_state('networkidle')
            print("âœ… í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ")

            # ========================================
            # í…ŒìŠ¤íŠ¸ ë¡œì§ ì‹œì‘
            # ========================================

            # 1. ì†Œì…œ íƒ­ í´ë¦­ (ì‚¬ì „ì¡°ê±´ 1)
            print("ğŸ“Œ ì†Œì…œ íƒ­ í´ë¦­")
            social_tab = page.get_by_role('link', name='ì†Œì…œ')
            await social_tab.click()
            await page.wait_for_load_state('networkidle')
            print("âœ… ì†Œì…œ íƒ­ ì§„ì… ì™„ë£Œ")

            # 2. íšŒì›ê°€ì…/ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ (ì‚¬ì „ì¡°ê±´ 2)
            print("ğŸ“Œ íšŒì›ê°€ì…/ë¡œê·¸ì¸ í˜ì´ì§€ ì§„ì…")
            # ë¡œê·¸ì¸ ë²„íŠ¼ ì°¾ê¸° - ì—¬ëŸ¬ ê°€ëŠ¥ì„± ì‹œë„
            try:
                # GNBì˜ ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
                login_button = page.get_by_role('button', name='íšŒì›ê°€ì…/ë¡œê·¸ì¸')
                await login_button.click()
            except:
                # ë‹¤ë¥¸ ë¡œê·¸ì¸ ë²„íŠ¼ ì‹œë„
                login_button = page.locator('button:has-text("ë¡œê·¸ì¸")')
                await login_button.first.click()

            await page.wait_for_load_state('networkidle')
            print("âœ… íšŒì›ê°€ì…/ë¡œê·¸ì¸ í˜ì´ì§€ ì§„ì… ì™„ë£Œ")

            # 3. ì´ë©”ì¼ë¡œ ê³„ì†í•˜ê¸° ë²„íŠ¼ ì„ íƒ (í™•ì¸ì‚¬í•­ 1)
            print("ğŸ“Œ ì´ë©”ì¼ë¡œ ê³„ì†í•˜ê¸° ë²„íŠ¼ í´ë¦­")
            email_continue_button = page.get_by_role('button', name='ì´ë©”ì¼ë¡œ ê³„ì†í•˜ê¸°')
            await email_continue_button.click()
            await page.wait_for_timeout(1000)  # í¼ ë¡œë“œ ëŒ€ê¸°
            print("âœ… ì´ë©”ì¼ ë¡œê·¸ì¸ í¼ í‘œì‹œ")

            # 4. ì´ë©”ì¼ ë° ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ (í™•ì¸ì‚¬í•­ 2)
            print("ğŸ“Œ ì´ë©”ì¼ ë° ë¹„ë°€ë²ˆí˜¸ ì…ë ¥")

            # ì´ë©”ì¼ ì…ë ¥
            email_input = page.locator('input[type="email"]')
            await email_input.fill(TEST_EMAIL)
            print(f"âœ… ì´ë©”ì¼ ì…ë ¥: {TEST_EMAIL}")

            # ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
            password_input = page.locator('input[type="password"]')
            await password_input.fill(TEST_PASSWORD)
            print("âœ… ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì™„ë£Œ")

            # 5. ë¡œê·¸ì¸ ë²„íŠ¼ ì„ íƒ (í™•ì¸ì‚¬í•­ 3)
            print("ğŸ“Œ ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­")
            login_submit_button = page.get_by_role('button', name='ë¡œê·¸ì¸')
            await login_submit_button.click()

            # 6. ë¡œê·¸ì¸ ì™„ë£Œ ë° ë¦¬ë‹¤ì´ë ‰íŠ¸ ëŒ€ê¸°
            print("ğŸ“Œ ë¡œê·¸ì¸ ì²˜ë¦¬ ë° ë¦¬ë‹¤ì´ë ‰íŠ¸ ëŒ€ê¸°")
            await page.wait_for_load_state('networkidle', timeout=10000)

            # 7. ì†Œì…œ íƒ­ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ í™•ì¸ (ê¸°ëŒ€ê²°ê³¼)
            current_url = page.url
            print(f"ğŸ“Œ í˜„ì¬ URL: {current_url}")

            # ë¡œê·¸ì¸ ì„±ê³µ í™•ì¸ - ì†Œì…œ í˜ì´ì§€ì— ìˆê³  ë¡œê·¸ì¸ ìƒíƒœì¸ì§€ í™•ì¸
            if 'social' in current_url or 'community' in current_url:
                print("âœ… ì†Œì…œ íƒ­ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ í™•ì¸")
            else:
                # URLì´ ë³€ê²½ë˜ì§€ ì•Šì•˜ë‹¤ë©´ í˜ì´ì§€ ë‚´ìš©ìœ¼ë¡œ í™•ì¸
                await page.wait_for_timeout(2000)
                current_url = page.url
                print(f"ğŸ“Œ ì¬í™•ì¸ URL: {current_url}")

            # ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ (í”„ë¡œí•„ ì•„ì´ì½˜ì´ë‚˜ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì¡´ì¬ í™•ì¸)
            try:
                # ë¡œê·¸ì¸ í›„ í‘œì‹œë˜ëŠ” ìš”ì†Œ í™•ì¸
                profile_element = page.locator('[data-attribute-id="gnb__user-profile"]').first
                await profile_element.wait_for(state='visible', timeout=5000)
                print("âœ… ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸: í”„ë¡œí•„ ì•„ì´ì½˜ í‘œì‹œë¨")
            except:
                print("âš ï¸ í”„ë¡œí•„ ì•„ì´ì½˜ í™•ì¸ ì‹¤íŒ¨, URLë¡œ íŒë‹¨")

            # ì„±ê³µ ìŠ¤í¬ë¦°ìƒ·
            await page.screenshot(path='screenshots/test_11_success.png', full_page=True)
            print("âœ… í…ŒìŠ¤íŠ¸ ì„±ê³µ")
            print("AUTOMATION_SUCCESS")  # â­ ì„±ê³µ ì‹œê·¸ë„
            return True

        except Exception as e:
            print(f"âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}")
            # ì‹¤íŒ¨ ì‹œ ìŠ¤í¬ë¦°ìƒ·
            try:
                await page.screenshot(path='screenshots/test_11_failed.png', full_page=True)
            except:
                pass
            print(f"AUTOMATION_FAILED: {e}")  # â­ ì‹¤íŒ¨ ì‹œê·¸ë„
            return False

        finally:
            await browser.close()

if __name__ == "__main__":
    result = asyncio.run(main())
    sys.exit(0 if result else 1)
